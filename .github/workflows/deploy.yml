name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy target"
        type: choice
        options:
          - production
        default: production

concurrency:
  group: deploy-fxnotification
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore Backend/Service/EmailWorker.csproj

      - name: Build
        run: dotnet build Backend/Service/EmailWorker.csproj --configuration Release --no-restore

      - name: Publish
        run: dotnet publish Backend/Service/EmailWorker.csproj --configuration Release --output ./publish/backend --no-build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend
          path: publish/backend/
          retention-days: 3

  deploy:
    name: Deploy Windows Service
    needs: build
    runs-on: [self-hosted, windows, iis]
    steps:
      - name: Set environment variables
        shell: powershell
        run: |
          echo "SERVICE_NAME=FX_Notify" >> $env:GITHUB_ENV
          echo "SERVICE_PATH=F:\New_WWW\FXNotify" >> $env:GITHUB_ENV

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: backend
          path: artifacts/backend

      - name: Stop Windows Service
        shell: powershell
        run: |
          $svc = "${{ env.SERVICE_NAME }}"
          Write-Host "[DEPLOY] Stopping service: $svc"
          $service = Get-Service -Name $svc -ErrorAction SilentlyContinue
          if ($service -and $service.Status -eq "Running") {
            Stop-Service -Name $svc -Force
            $service.WaitForStatus("Stopped", [TimeSpan]::FromSeconds(30))
            Write-Host "[DEPLOY] Service stopped"
          } else {
            Write-Host "[DEPLOY] Service not running or not found"
          }

      - name: Backup current deployment
        shell: powershell
        run: |
          $svcPath = "${{ env.SERVICE_PATH }}"
          $backupRoot = "F:\deploy-backups\FXNotify"
          $timestamp = Get-Date -Format "yyyy-MM-dd_HHmmss"
          $backupDir = Join-Path $backupRoot $timestamp
          if (Test-Path $svcPath) {
            Write-Host "[BACKUP] Backing up to $backupDir"
            New-Item -ItemType Directory -Path $backupDir -Force | Out-Null
            Copy-Item -Path "$svcPath\*" -Destination $backupDir -Recurse -Force -Exclude @("logs", "appsettings.Production.json")
            Write-Host "[BACKUP] Done"
            # Keep only last 5 backups
            $allBackups = Get-ChildItem $backupRoot -Directory -ErrorAction SilentlyContinue | Sort-Object Name -Descending
            if ($allBackups.Count -gt 5) {
              $allBackups | Select-Object -Skip 5 | ForEach-Object {
                Remove-Item $_.FullName -Recurse -Force
              }
            }
          } else {
            Write-Host "[BACKUP] No existing deployment - creating directory"
            New-Item -ItemType Directory -Path $svcPath -Force | Out-Null
          }

      - name: Deploy service binary
        shell: powershell
        run: |
          $svcPath = "${{ env.SERVICE_PATH }}"
          Write-Host "[DEPLOY] Deploying to $svcPath"
          # Remove old files, preserve config and logs
          Get-ChildItem $svcPath -Exclude @("appsettings.Production.json", "appsettings.production.json", "logs") | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          # Copy new files
          Copy-Item -Path "artifacts\backend\*" -Destination $svcPath -Recurse -Force
          Write-Host "[DEPLOY] Files deployed"

      - name: Start Windows Service
        shell: powershell
        run: |
          $svc = "${{ env.SERVICE_NAME }}"
          $service = Get-Service -Name $svc -ErrorAction SilentlyContinue
          if ($service) {
            Write-Host "[DEPLOY] Starting service: $svc"
            Start-Service -Name $svc
            Start-Sleep -Seconds 3
            $service.Refresh()
            Write-Host "[DEPLOY] Service status: $($service.Status)"
            if ($service.Status -ne "Running") {
              Write-Host "##[error]Service failed to start!"
              exit 1
            }
          } else {
            Write-Host "##[error]Service '$svc' not registered!"
            exit 1
          }

      - name: Summary
        if: always()
        shell: powershell
        run: |
          $commitHash = "${{ github.sha }}".Substring(0,7)
          Write-Host "DEPLOYMENT COMPLETE: FX_Notify ($commitHash)"
          exit 0
